"use strict";
(() => {
var exports = {};
exports.id = 7;
exports.ids = [7];
exports.modules = {

/***/ 33009:
/***/ ((module) => {

module.exports = require("@umami/prisma-client");

/***/ }),

/***/ 86505:
/***/ ((module) => {

module.exports = require("@umami/redis-client");

/***/ }),

/***/ 97679:
/***/ ((module) => {

module.exports = require("clickhouse");

/***/ }),

/***/ 33582:
/***/ ((module) => {

module.exports = require("cors");

/***/ }),

/***/ 66011:
/***/ ((module) => {

module.exports = require("date-fns/addDays");

/***/ }),

/***/ 97309:
/***/ ((module) => {

module.exports = require("date-fns/addHours");

/***/ }),

/***/ 45569:
/***/ ((module) => {

module.exports = require("date-fns/addMinutes");

/***/ }),

/***/ 54538:
/***/ ((module) => {

module.exports = require("date-fns/addMonths");

/***/ }),

/***/ 74403:
/***/ ((module) => {

module.exports = require("date-fns/addYears");

/***/ }),

/***/ 14521:
/***/ ((module) => {

module.exports = require("date-fns/differenceInCalendarDays");

/***/ }),

/***/ 61829:
/***/ ((module) => {

module.exports = require("date-fns/differenceInCalendarMonths");

/***/ }),

/***/ 96016:
/***/ ((module) => {

module.exports = require("date-fns/differenceInCalendarYears");

/***/ }),

/***/ 40581:
/***/ ((module) => {

module.exports = require("date-fns/differenceInHours");

/***/ }),

/***/ 69472:
/***/ ((module) => {

module.exports = require("date-fns/differenceInMinutes");

/***/ }),

/***/ 40557:
/***/ ((module) => {

module.exports = require("date-fns/endOfDay");

/***/ }),

/***/ 71463:
/***/ ((module) => {

module.exports = require("date-fns/endOfHour");

/***/ }),

/***/ 96924:
/***/ ((module) => {

module.exports = require("date-fns/endOfMonth");

/***/ }),

/***/ 63864:
/***/ ((module) => {

module.exports = require("date-fns/endOfWeek");

/***/ }),

/***/ 55018:
/***/ ((module) => {

module.exports = require("date-fns/endOfYear");

/***/ }),

/***/ 14384:
/***/ ((module) => {

module.exports = require("date-fns/format");

/***/ }),

/***/ 35646:
/***/ ((module) => {

module.exports = require("date-fns/isDate");

/***/ }),

/***/ 15081:
/***/ ((module) => {

module.exports = require("date-fns/isValid");

/***/ }),

/***/ 45564:
/***/ ((module) => {

module.exports = require("date-fns/locale");

/***/ }),

/***/ 90986:
/***/ ((module) => {

module.exports = require("date-fns/max");

/***/ }),

/***/ 78542:
/***/ ((module) => {

module.exports = require("date-fns/min");

/***/ }),

/***/ 61369:
/***/ ((module) => {

module.exports = require("date-fns/parseISO");

/***/ }),

/***/ 7585:
/***/ ((module) => {

module.exports = require("date-fns/startOfDay");

/***/ }),

/***/ 26538:
/***/ ((module) => {

module.exports = require("date-fns/startOfHour");

/***/ }),

/***/ 58535:
/***/ ((module) => {

module.exports = require("date-fns/startOfMinute");

/***/ }),

/***/ 45914:
/***/ ((module) => {

module.exports = require("date-fns/startOfMonth");

/***/ }),

/***/ 2659:
/***/ ((module) => {

module.exports = require("date-fns/startOfWeek");

/***/ }),

/***/ 92559:
/***/ ((module) => {

module.exports = require("date-fns/startOfYear");

/***/ }),

/***/ 95358:
/***/ ((module) => {

module.exports = require("date-fns/subDays");

/***/ }),

/***/ 97863:
/***/ ((module) => {

module.exports = require("date-fns/subHours");

/***/ }),

/***/ 30829:
/***/ ((module) => {

module.exports = require("date-fns/subMinutes");

/***/ }),

/***/ 61360:
/***/ ((module) => {

module.exports = require("date-fns/subMonths");

/***/ }),

/***/ 62695:
/***/ ((module) => {

module.exports = require("date-fns/subWeeks");

/***/ }),

/***/ 75809:
/***/ ((module) => {

module.exports = require("date-fns/subYears");

/***/ }),

/***/ 96974:
/***/ ((module) => {

module.exports = require("debug");

/***/ }),

/***/ 43791:
/***/ ((module) => {

module.exports = require("detect-browser");

/***/ }),

/***/ 29159:
/***/ ((module) => {

module.exports = require("ipaddr.js");

/***/ }),

/***/ 9028:
/***/ ((module) => {

module.exports = require("is-localhost-ip");

/***/ }),

/***/ 44543:
/***/ ((module) => {

module.exports = require("kafkajs");

/***/ }),

/***/ 85524:
/***/ ((module) => {

module.exports = require("maxmind");

/***/ }),

/***/ 68362:
/***/ ((module) => {

module.exports = require("moment-timezone");

/***/ }),

/***/ 68884:
/***/ ((module) => {

module.exports = require("next-basics");

/***/ }),

/***/ 90730:
/***/ ((module) => {

module.exports = require("next/dist/server/api-utils/node.js");

/***/ }),

/***/ 43076:
/***/ ((module) => {

module.exports = require("next/dist/server/future/route-modules/route-module.js");

/***/ }),

/***/ 52316:
/***/ ((module) => {

module.exports = require("request-ip");

/***/ }),

/***/ 75609:
/***/ ((module) => {

module.exports = require("yup");

/***/ }),

/***/ 70400:
/***/ ((module) => {

module.exports = import("dateformat");;

/***/ }),

/***/ 84711:
/***/ ((module) => {

module.exports = import("isbot");;

/***/ }),

/***/ 46555:
/***/ ((module) => {

module.exports = import("uuid");;

/***/ }),

/***/ 86003:
/***/ ((module) => {

module.exports = require("dns/promises");

/***/ }),

/***/ 71017:
/***/ ((module) => {

module.exports = require("path");

/***/ }),

/***/ 5763:
/***/ ((module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   config: () => (/* binding */ config),
/* harmony export */   "default": () => (__WEBPACK_DEFAULT_EXPORT__),
/* harmony export */   routeModule: () => (/* binding */ routeModule)
/* harmony export */ });
/* harmony import */ var next_dist_server_future_route_modules_pages_api_module__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(56429);
/* harmony import */ var next_dist_server_future_route_modules_pages_api_module__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_pages_api_module__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(47153);
/* harmony import */ var next_dist_build_webpack_loaders_next_route_loader_helpers__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(37305);
/* harmony import */ var private_next_pages_api_send_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(14583);
var __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([private_next_pages_api_send_ts__WEBPACK_IMPORTED_MODULE_3__]);
private_next_pages_api_send_ts__WEBPACK_IMPORTED_MODULE_3__ = (__webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__)[0];
// @ts-ignore this need to be imported from next/dist to be external



const PagesAPIRouteModule = next_dist_server_future_route_modules_pages_api_module__WEBPACK_IMPORTED_MODULE_0__.PagesAPIRouteModule;
// Import the userland code.
// @ts-expect-error - replaced by webpack/turbopack loader

// Re-export the handler (should be the default export).
/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((0,next_dist_build_webpack_loaders_next_route_loader_helpers__WEBPACK_IMPORTED_MODULE_2__/* .hoist */ .l)(private_next_pages_api_send_ts__WEBPACK_IMPORTED_MODULE_3__, "default"));
// Re-export config.
const config = (0,next_dist_build_webpack_loaders_next_route_loader_helpers__WEBPACK_IMPORTED_MODULE_2__/* .hoist */ .l)(private_next_pages_api_send_ts__WEBPACK_IMPORTED_MODULE_3__, "config");
// Create and export the route module that will be consumed.
const routeModule = new PagesAPIRouteModule({
    definition: {
        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__/* .RouteKind */ .x.PAGES_API,
        page: "/api/send",
        pathname: "/api/send",
        // The following aren't used in production.
        bundlePath: "",
        filename: ""
    },
    userland: private_next_pages_api_send_ts__WEBPACK_IMPORTED_MODULE_3__
});

//# sourceMappingURL=pages-api.js.map
__webpack_async_result__();
} catch(e) { __webpack_async_result__(e); } });

/***/ }),

/***/ 14583:
/***/ ((module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "default": () => (__WEBPACK_DEFAULT_EXPORT__)
/* harmony export */ });
/* harmony import */ var dns_promises__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(86003);
/* harmony import */ var dns_promises__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(dns_promises__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var ipaddr_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(29159);
/* harmony import */ var ipaddr_js__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(ipaddr_js__WEBPACK_IMPORTED_MODULE_1__);
/* harmony import */ var isbot__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(84711);
/* harmony import */ var lib_constants__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(55510);
/* harmony import */ var lib_crypto__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(30249);
/* harmony import */ var lib_detect__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(4249);
/* harmony import */ var lib_middleware__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(24531);
/* harmony import */ var next_basics__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(68884);
/* harmony import */ var next_basics__WEBPACK_IMPORTED_MODULE_7___default = /*#__PURE__*/__webpack_require__.n(next_basics__WEBPACK_IMPORTED_MODULE_7__);
/* harmony import */ var queries__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(37451);
/* harmony import */ var yup__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(75609);
/* harmony import */ var yup__WEBPACK_IMPORTED_MODULE_9___default = /*#__PURE__*/__webpack_require__.n(yup__WEBPACK_IMPORTED_MODULE_9__);
var __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([isbot__WEBPACK_IMPORTED_MODULE_2__, lib_crypto__WEBPACK_IMPORTED_MODULE_4__, lib_middleware__WEBPACK_IMPORTED_MODULE_6__, queries__WEBPACK_IMPORTED_MODULE_8__]);
([isbot__WEBPACK_IMPORTED_MODULE_2__, lib_crypto__WEBPACK_IMPORTED_MODULE_4__, lib_middleware__WEBPACK_IMPORTED_MODULE_6__, queries__WEBPACK_IMPORTED_MODULE_8__] = __webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__);










const schema = {
    POST: yup__WEBPACK_IMPORTED_MODULE_9__.object().shape({
        payload: yup__WEBPACK_IMPORTED_MODULE_9__.object().shape({
            data: yup__WEBPACK_IMPORTED_MODULE_9__.object(),
            hostname: yup__WEBPACK_IMPORTED_MODULE_9__.string().matches(lib_constants__WEBPACK_IMPORTED_MODULE_3__/* .HOSTNAME_REGEX */ .m$).max(100),
            language: yup__WEBPACK_IMPORTED_MODULE_9__.string().max(35),
            referrer: yup__WEBPACK_IMPORTED_MODULE_9__.string().max(500),
            screen: yup__WEBPACK_IMPORTED_MODULE_9__.string().max(11),
            title: yup__WEBPACK_IMPORTED_MODULE_9__.string().max(500),
            url: yup__WEBPACK_IMPORTED_MODULE_9__.string().max(500),
            website: yup__WEBPACK_IMPORTED_MODULE_9__.string().uuid().required(),
            name: yup__WEBPACK_IMPORTED_MODULE_9__.string().max(50)
        }).required(),
        type: yup__WEBPACK_IMPORTED_MODULE_9__.string().matches(/event|identify/i).required()
    })
};
/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (async (req, res)=>{
    await (0,lib_middleware__WEBPACK_IMPORTED_MODULE_6__/* .useCors */ .mS)(req, res);
    if (req.method === "POST") {
        if ((0,isbot__WEBPACK_IMPORTED_MODULE_2__["default"])(req.headers["user-agent"]) && !process.env.DISABLE_BOT_CHECK) {
            return (0,next_basics__WEBPACK_IMPORTED_MODULE_7__.ok)(res);
        }
        const { type, payload } = req.body;
        req.yup = schema;
        await (0,lib_middleware__WEBPACK_IMPORTED_MODULE_6__/* .useValidate */ ._w)(req, res);
        if (await hasBlockedIp(req)) {
            return (0,next_basics__WEBPACK_IMPORTED_MODULE_7__.forbidden)(res);
        }
        const { url, referrer, name: eventName, data: eventData, title: pageTitle } = payload;
        await (0,lib_middleware__WEBPACK_IMPORTED_MODULE_6__/* .useSession */ .kP)(req, res);
        const session = req.session;
        if (type === lib_constants__WEBPACK_IMPORTED_MODULE_3__/* .COLLECTION_TYPE */ .Ii.event) {
            // eslint-disable-next-line prefer-const
            let [urlPath, urlQuery] = url?.split("?") || [];
            let [referrerPath, referrerQuery] = referrer?.split("?") || [];
            let referrerDomain;
            if (!urlPath) {
                urlPath = "/";
            }
            if (referrerPath?.startsWith("http")) {
                const refUrl = new URL(referrer);
                referrerPath = refUrl.pathname;
                referrerQuery = refUrl.search.substring(1);
                referrerDomain = refUrl.hostname.replace(/www\./, "");
            }
            if (process.env.REMOVE_TRAILING_SLASH) {
                urlPath = urlPath.replace(/.+\/$/, "");
            }
            await (0,queries__WEBPACK_IMPORTED_MODULE_8__/* .saveEvent */ .ry)({
                urlPath,
                urlQuery,
                referrerPath,
                referrerQuery,
                referrerDomain,
                pageTitle,
                eventName,
                eventData,
                ...session,
                sessionId: session.id
            });
        }
        if (type === lib_constants__WEBPACK_IMPORTED_MODULE_3__/* .COLLECTION_TYPE */ .Ii.identify) {
            if (!eventData) {
                return (0,next_basics__WEBPACK_IMPORTED_MODULE_7__.badRequest)(res, "Data required.");
            }
            await (0,queries__WEBPACK_IMPORTED_MODULE_8__/* .saveSessionData */ .fW)({
                ...session,
                sessionData: eventData,
                sessionId: session.id
            });
        }
        const token = (0,next_basics__WEBPACK_IMPORTED_MODULE_7__.createToken)(session, (0,lib_crypto__WEBPACK_IMPORTED_MODULE_4__/* .secret */ .zY)());
        return (0,next_basics__WEBPACK_IMPORTED_MODULE_7__.send)(res, token);
    }
    return (0,next_basics__WEBPACK_IMPORTED_MODULE_7__.methodNotAllowed)(res);
});
async function hasBlockedIp(req) {
    const ignoreIps = process.env.IGNORE_IP;
    const ignoreHostnames = process.env.IGNORE_HOSTNAME;
    if (ignoreIps || ignoreHostnames) {
        const ips = [];
        if (ignoreIps) {
            ips.push(...ignoreIps.split(",").map((n)=>n.trim()));
        }
        if (ignoreHostnames) {
            const resolver = new dns_promises__WEBPACK_IMPORTED_MODULE_0__.Resolver();
            const promises = ignoreHostnames.split(",").map((n)=>resolver.resolve4(n.trim()).catch(()=>{}));
            await Promise.all(promises).then((resolvedIps)=>{
                ips.push(...resolvedIps.filter((n)=>n).flatMap((n)=>n));
            });
        }
        const clientIp = (0,lib_detect__WEBPACK_IMPORTED_MODULE_5__/* .getIpAddress */ .I_)(req);
        return ips.find((ip)=>{
            if (ip === clientIp) return true;
            // CIDR notation
            if (ip.indexOf("/") > 0) {
                const addr = ipaddr_js__WEBPACK_IMPORTED_MODULE_1___default().parse(clientIp);
                const range = ipaddr_js__WEBPACK_IMPORTED_MODULE_1___default().parseCIDR(ip);
                if (addr.kind() === range[0].kind() && addr.match(range)) return true;
            }
            return false;
        });
    }
}

__webpack_async_result__();
} catch(e) { __webpack_async_result__(e); } });

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../webpack-api-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, [172,5510,4531], () => (__webpack_exec__(5763)));
module.exports = __webpack_exports__;

})();